{% load static %}
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'img/logo.png' %}" type="image">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/fav/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/fav/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/fav/favicon-16x16.png' %}">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css"/>

    <!-- Подключение Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
    <!-- Подключение Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Подключение Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Подключение MDB CSS -->
    <link rel="stylesheet" href="{% static "mdb/css/mdb.min.css" %}">
    <!-- Подключение кастомных стилей -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <title>{% block title %}Домашняя страница{% endblock %}</title>
</head>

<body>
    {% include 'includes/navigation.html' %}
    <!-- Основное содержимое -->
    <main style="min-height: calc(100vh - 56px);">
        {% block content %}{% endblock %}
    </main>
    {% include 'includes/paginator.html' %}
    <!-- Подвал -->
    {% include 'includes/footer.html' %}
    {% include 'includes/button_back2top.html' %}

    <!-- Подключение MDB JS -->
    <script src="{% static "mdb/js/mdb.min.js" %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Функция для переключения состояния меню
        function menuToggle() {
            var menuDrawer = document.getElementById('menuDrawer');
            menuDrawer.classList.toggle('active');
        }
    
        // Функция для закрытия меню
        function closeMenuDrawer() {
            var menuDrawer = document.getElementById('menuDrawer');
            menuDrawer.classList.remove('active');
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            let currentPage = 1; // Текущая страница
            let query = ''; // Переменная для хранения текущего запроса
    
            $('#search-input').on('keyup', function() {
                query = $(this).val();
                currentPage = 1; // Сбросить страницу при новом поисковом запросе
                performSearch(query, currentPage); // Выполнить поиск
            });
    
            $('#load-more').on('click', function() {
                currentPage++;
                performSearch(query, currentPage); // Загрузить следующую страницу
            });
    
            function performSearch(query, page) {
                if (query.length > 1) {
                    $.ajax({
                        url: '{% url "store:ajax_search" %}',
                        data: { 'query': query, 'page': page },
                        success: function(data) {
                            let results = data.results;
                            let suggestionsList = $('#suggestions-list');
    
                            if (page === 1) {
                                suggestionsList.empty(); // Очистить предыдущие результаты
                            }
    
                            results.forEach(result => {
                                let listItem = `
                                    <li class="d-flex align-items-center p-2 border-bottom">
                                        <img src="${result.image_url}" alt="Product Image" class="me-2" style="width: 40px; height: 40px; border-radius: 5px;">
                                        <div class="product-info">
                                            <span class="product-name"><a href="${result.url}">${result.name}</a></span>
                                            <span class="category-name"><a href="${result.category_url}">${result.category}</a></span>
                                            <span class="category-name text-muted">${result.article_number}</span>
                                            <span class="product-price text-primary">${result.price} руб.</span>
                                        </div>
                                    </li>
                                `;
                                suggestionsList.append(listItem);
                            });
    
                            if (results.length === 0 && page === 1) {
                                suggestionsList.append('<li class="text-muted text-center p-2">Ничего не найдено.</li>');
                            }
    
                            if (data.has_more) {
                                $('#load-more').show();
                            } else {
                                $('#load-more').hide();
                            }
    
                            $('#suggestions').show(); // Показать результаты
                        }
                    });
                } else {
                    $('#suggestions').hide();
                }
            }
        });
    </script>
    <script>
        let mybutton = document.getElementById("btn-back-to-top");

        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function () {
          scrollFunction();
        };
        
        function scrollFunction() {
          if (
            document.body.scrollTop > 20 ||
            document.documentElement.scrollTop > 20
          ) {
            mybutton.style.display = "block";
          } else {
            mybutton.style.display = "none";
          }
        }
        // When the user clicks on the button, scroll to the top of the document
        mybutton.addEventListener("click", backToTop);
        
        function backToTop() {
          document.body.scrollTop = 0;
          document.documentElement.scrollTop = 0;
        }        
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.favorite-button').click(function() {
                var productId = $(this).data('product-number');
                var button = $(this);
                var icon = button.find('i');

                $.ajax({
                    url: "{% url 'user:toggle_favorite' 0 %}".replace('0', productId),
                    type: 'POST',
                    data: {
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.is_favorite) {
                            icon.removeClass('far fa-heart').addClass('fas fa-heart');  // Заменяем иконку на заполненное сердце
                        } else {
                            icon.removeClass('fas fa-heart').addClass('far fa-heart');  // Заменяем иконку на пустое сердце
                        }
                    }
                });
            });
        });
    </script>

</body>
</html>
